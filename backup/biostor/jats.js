{"_id":"_design/jats","_rev":"9-ac2d25ee38c8e65970a3f2a2bd5701f7","language":"javascript","views":{"cites":{"map":"//----------------------------------------------------------------------------------------\nfunction is_name(str) {\n\tvar is_name = false;\n\t\n\tif (str.match(/[A-Z][a-zA-Z]+,\\s*([A-Z]\\.\\s*)+/)) {\n\t\tis_name = true;\n\t}\n\t\n\treturn is_name;\n}\n\n//----------------------------------------------------------------------------------------\nfunction is_end_of_citation(str, mean_line_length) {\n\tvar is_end = false;\n\t\n\t// page range\n\tif (str.match(/[­|-|—|–|-](\\d+)\\.?\\s*$/)) {\n\t\tis_end = true;\n\t}\n        // page range with translation\n\tif (str.match(/[­|-|—|–|-](\\d+)\\.?\\s*(\\[|\\))[I|i]n\\s+[A-Z][a-z]+(\\]|\\))$/)) {\n\t\tis_end = true;\n\t}\n\t\n\t// DOI\n\t//  - doi: 10.1080/00222938809460919\n\tif (str.match(/(\\s+[-|-]\\s+)?doi:\\s*10\\.\\d+\\/(.*)$/)) {\n\t\tis_end = true;\n\t}\n\n\tif (str.match(/pp\\.(\\s+\\w+\\.)?$/)) {\n\t\tis_end = true;\n\t}\n\n\t// F C Thompson-style references\n\tif (str.match(/([0-9]{2}|\\?\\?)\\]$/)) {\n\t\tis_end = true;\n\t}\n\n\tif (str.match(/\\.\\]$/)) {\n\t\tis_end = true;\n\t}\n\n\t// pdf]\n\tif (str.match(/pdf\\]\\s*$/)) {\n\t\tis_end = true;\n\t}\n\n\tif (str.match(/html\\.\\s*$/)) {\n\t\tis_end = true;\n\t}\n\n\n\tif (str.match(/\\.$/)) {\n\t\tif (str.length < mean_line_length) {\n\t\t\tif (!is_name(str)) {\n\t\t\t\tis_end = true;\n\t\t\t}\n\t\t}\n\t}\n\t\n\treturn is_end;\n}\n\n\n\n//----------------------------------------------------------------------------------------\nfunction extract_citations (pages) {\n\tvar citations = [];\n\t\n\tvar sum_line_length = 0;\n\tvar num_lines = 0;\n\t\n\tfor (var i in pages) {\n\t\tvar lines = pages[i].split(/\\n/);\n\t\tnum_lines += lines.length;\n\t\t\n\t\tfor (var j in lines) {\n\t\t\tsum_line_length += lines[j].length;\n\t\t}\n\t}\n\tvar mean_line_length = sum_line_length / num_lines;\n\t\n\t\n\tvar STATE_START = 0;\n\tvar STATE_IN_REFERENCES = 1;\n\tvar STATE_OUT_REFERENCES = 2;\n\tvar STATE_START_CITATION = 3;\n\tvar STATE_END_CITATION = 4;\n\n\tvar state = STATE_START;\n\n\tvar citation = '';\n\t\n\tfor (var i in pages) {\n                // case where newlines are escaped, e.g Journal of Hymenoptera Research\n \t\tpage = pages[i];\n\t\tpage = page.replace(/\\\\n/g, '\\n');\n \t\tlines = page.split(/\\n/);\n\t\t\t\t\t\t\n\t\tvar n = lines.length;\n\t\tvar line_number = 0;\n\n\t\t// Handle hyphenation\n\t\tvar hyphens = [];\n\t\thyphens[0] = 0;\n\n\t\t// Skip running head\n\t\tline_number++;\n\t\n\t\t// Hyphen\n\t\tvar last_line_had_hyphen = false;\n\n\t\twhile ((state != STATE_OUT_REFERENCES) && (line_number < n)) {\n\t\t\tline = lines[line_number];\t\n\t\t\tline = line.replace(/^\\s+/, '');\n\t\t\tline = line.replace(/\\s+$/, '');\n\t\t\t\n\t\t\t//document.write(line);\n\t\t\t\n\t\t\t// Trim and flag hyphenation\n\t\t\tif (line.match(/[A-Za-z][-|­]\\s*$/)) {\n\t\t\t\tline = line.replace(/[-|­]\\s*$/, '');\n\t\t\t\thyphens[line_number] = 1;\n\t\t\t} else {\n\t\t\t\thyphens[line_number] = 0;\n\t\t\t}\n\t\t\t\t\t\t\t\t\t\n\t\t\tswitch (state) {\n\t\t\t\tcase STATE_START:\n\t\t\t\t\t// Look for references\n\t\t\t\t\tif (line.match(/^\\s*(REFERENCES|LITERATURE CITED|ZOOTAXA References|LITERATURA CITADA\\s*)$/i)) {\n\t\t\t\t\t\t// Ignore table of contents\n\t\t\t\t\t\tif (line.match(/\\.?\\s*[0-9]$/)) {\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tstate = STATE_IN_REFERENCES;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase STATE_IN_REFERENCES:\n\t\t\t\t\tif (line.match(/^([A-Z]|\\.\\s*[0-9]{4})/))\n\t\t\t\t\t{\n\t\t\t\t\t\tif (line.match(/^((Note[s]? added in proof)|(Appendix)|(Buchbesprechungen)|(Figure)|(Index)|(Recibido))/i)) {\n\t\t\t\t\t\t\tstate = STATE_OUT_REFERENCES;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tstate = STATE_START_CITATION;\n\t\t\t\t\t\t\tcitation = line;\n\t\t\t\t\t\t\tif (is_end_of_citation(line, mean_line_length)) {\n\t\t\t\t\t\t\t\tcitations.push(citation);\n\t\t\t\t\t\t\t\tstate = STATE_IN_REFERENCES;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tcase STATE_START_CITATION:\n\t\t\t\t\tif (hyphens[line_number - 1] == 0) {\n\t\t\t\t\t\tcitation += ' ';\n\t\t\t\t\t}\n\t\t\t\t\tcitation += line;\n\t\t\t\t\tif (is_end_of_citation(line, mean_line_length))\n\t\t\t\t\t{\n\t\t\t\t\t\tcitations.push(citation);\n\t\t\t\t\t\t\n\t\t\t\t\t\tstate = STATE_IN_REFERENCES;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t\tdefault:\n\t\t\t\t\tbreak;\n\t\t\t\t\n\t\t\t}\n\t\t\tline_number++;\n\n\t\t}\n\n\t}\t\t\n\t\n\treturn citations;\n}\n\t\n\nfunction(doc) {\n  if (doc.text) {\n\n    // only do this for some journals\n    var issn = '';\n    if (doc.journal) {\n      if (doc.journal.identifier) {\n        for (var i in doc.journal.identifier) {\n          if (doc.journal.identifier[i].type == 'issn') {\n            issn = doc.journal.identifier[i].id;\n          }\n        }\n      }\n    }\n   // could do this for just a set number of journals, or for all\n   switch (issn) {\n     case '0035-418X': // Revue Suisse Zoologie\n     case '0374-7859': // Garden's Bulletin Singapore\n     case '1018-4171': // Arachnologische Mitteilungen\n     default:\n       var citations = extract_citations(doc.text);\n       for (var i in citations) {\n          emit(doc._id, [i,citations[i]]);\n       } \n       break;\n     /*\n     default:\n       break;\n     */\n    }\n  }\n}"}}}
